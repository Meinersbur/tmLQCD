srcdir = @srcdir@
top_builddir =  @top_srcdir@
abs_top_builddir = @abs_top_builddir@
subdir = .


CC = @CC@
CCDEP = @CCDEP@
CFLAGS = @CFLAGS@ @OPTARGS@
LDFLAGS = @LDFLAGS@ @OPTARGS@
DEPFLAGS = @DEPFLAGS@
CCLD = $(CC)
LEX = @LEX@ 
AUTOCONF = @AUTOCONF@
LIBS = -lsolver -llinalg -llime @LIBS@ 
SHELL = @SHELL@
OPTARGS = @OPTARGS@

INCLUDES = @INCLUDES@ 
LINK = $(CCLD) -o $@ ${LDFLAGS}
LINKLIBS = ${top_builddir}/linalg/liblinalg.a  \
	${top_builddir}/solver/libsolver.a
COMPILE = ${CC} $(INCLUDES) -o $@ ${CFLAGS} 

MODULES = init_gauge_field init_geometry_indices init_spinor_field \
	init_bispinor_field init_moment_field init_gauge_tmp \
	read_input gamma linsolve xchange \
	expo hybrid_update observables start \
	geometry_eo linalg_eo ranlxd io Hopping_Matrix \
	boundary deriv_Sb tm_operators getopt sighandler \
	mpi_init update_tm Hopping_Matrix_nocom \
	test/check_geometry test/check_xchange invert_eo \
	measure_rectangles get_rectangle_staples \
	derivative_psf ext_integrator polyakov_loop \
	2mn_integrator \

PROGRAMS = hmc_tm testtrace thermal_cycle_tm benchmark invert gwc2ildg ildg2gwc
ALLOBJ = ${MODULES} ${PROGRAMS}
SUBDIRS = linalg solver

.SUFFIXES:

all: Makefile all-recursive dep ${LINKLIBS} hmc_tm invert gwc2ildg ildg2gwc

.NOTPARALLEL: 

-include $(addsuffix .d,$(ALLOBJ))

include ${top_builddir}/Makefile.global

flex_read_input: read_input.l
	${LEX} -i -t $< > read_input.c

${addsuffix .o, ${MODULES}}: %.o: %.c %.d Makefile
	${COMPILE} -c $< 

${addsuffix .o, ${PROGRAMS}}: %.o: %.c %.d Makefile
	${COMPILE} -c $<

${PROGRAMS}: %: %.o ${addsuffix .o, ${MODULES}} ${LINKLIBS}
	 ${LINK} ${addsuffix .o, ${MODULES}} $@.o $(LIBS)

dep: $(addsuffix .d,$(ALLOBJ))

compile-clean: Makefile
	@(cd linalg && $(MAKE) compile-clean)
	@(cd solver && $(MAKE) compile-clean)
	rm -f *.o *.d

clean: compile-clean
	@(cd linalg && $(MAKE) clean)
	@(cd solver && $(MAKE) clean)
	@rm -f hmc_tm hybrid

distclean: clean
	@rm -f Makefile
	@(cd linalg && $(MAKE) distclean)
	@(cd solver && $(MAKE) distclean)

.PHONY: all clean compile-clean distclean dep \
	flex_read_input ${PROGRAMS}
