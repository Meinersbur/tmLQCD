srcdir = @srcdir@
top_srcdir = @top_srcdir@
top_builddir =  .
abs_top_builddir = @abs_top_builddir@
builddir = @builddir@
subdir = .


CC = @CC@
CCDEP = @CCDEP@
CFLAGS = @CFLAGS@ 
LDFLAGS = @LDFLAGS@
DEPFLAGS = @DEPFLAGS@
CPPFLAGS = @CPPFLAGS@
CCLD = $(CC)
LEX = @LEX@ 
AUTOCONF = @AUTOCONF@
LIBS = @LIBS@ 
SHELL = @SHELL@
OPTARGS = @OPTARGS@
SOPTARGS = @SOPTARGS@
DEFS = @DEFS@

INCLUDES = @INCLUDES@ 
LINK = $(CCLD) -o $@ ${LDFLAGS} ${SOPTARGS}
LINKLIBS = ${top_builddir}/linalg/liblinalg.a  \
	${top_builddir}/solver/libsolver.a
COMPILE = ${CC} $(DEFS) $(INCLUDES) -o $@ ${CFLAGS}

SMODULES = Hopping_Matrix_nocom Hopping_Matrix tm_operators

PMODULES = init_chi_spinor_field init_chi_copy reweighting_factor_nd \
        chebyshev_polynomial_nd Ptilde_nd  Nondegenerate_Matrix \
	init_bispinor_field eigenvalues_bi max_eigenvalues_bi \
	update_tm_nd hybrid_nondegenerate_update

MODULES = read_input gamma hybrid_update observables start \
	expo 2mn_integrator get_staples update_backward_gauge \
	measure_rectangles get_rectangle_staples  \
	test/check_geometry test/check_xchange invert_eo \
	ext_integrator polyakov_loop getopt sighandler \
	source_generation boundary io update_tm ranlxd  \
	mpi_init linsolve deriv_Sb \
	xchange_deri geometry_eo linalg_eo \
	init_moment_field init_gauge_tmp \
	derivative_psf xchange_field xchange_gauge \
	init_gauge_field init_geometry_indices init_spinor_field \
	init_dirac_halfspinor xchange_halffield stout_smear 

PROGRAMS = hmc_tm benchmark invert gwc2ildg \
	ildg2gwc single2double double2single reducenoise gen_sources 

ALLOBJ = ${MODULES} ${PROGRAMS} ${SMODULES} ${PMODULES}
SUBDIRS = linalg solver

.SUFFIXES:

all: Makefile all-recursive dep ${LINKLIBS} hmc_tm invert

.NOTPARALLEL: 

-include $(addsuffix .d,$(ALLOBJ))

include ${top_srcdir}/Makefile.global

flex_read_input: read_input.l
	${LEX} -i -t $< > read_input.c

${addsuffix .o, ${MODULES}}: %.o: ${srcdir}/%.c %.d Makefile
	${COMPILE} ${OPTARGS} -c $< 

${addsuffix .o, ${SMODULES}}: %.o: ${srcdir}/%.c %.d Makefile
	${COMPILE} ${SOPTARGS} -c $< 

${addsuffix .o, ${PMODULES}}: %.o: ${srcdir}/%.c %.d Makefile
	${COMPILE} ${OPTARGS} -c $< 

${addsuffix .o, ${PROGRAMS}}: %.o: ${srcdir}/%.c %.d Makefile
	${COMPILE} ${OPTARGS} -c $<

${PROGRAMS}: %: %.o ${addsuffix .o, ${MODULES}} ${addsuffix .o, ${SMODULES}} ${LINKLIBS}
	 ${LINK} ${addsuffix .o, ${MODULES}} ${addsuffix .o, ${SMODULES}} $@.o $(LIBS)

phmc_tm: %: %.o ${addsuffix .o, ${MODULES}} ${addsuffix .o, ${PMODULES}} ${addsuffix .o, ${SMODULES}} ${LINKLIBS} ${srcdir}/phmc_tm.c
	 ${LINK} ${addsuffix .o, ${MODULES}} ${addsuffix .o, ${PMODULES}} ${addsuffix .o, ${SMODULES}} $@.o $(LIBS)


dep: $(addsuffix .d,$(ALLOBJ))

compile-clean: compile-clean-recursive Makefile
	rm -f *.o *.d

clean: clean-recursive Makefile
	rm -f hmc_tm invert phmc_tm*.o *.d
distclean: distclean-recursive Makefile
	rm -f hmc_tm hybrid *.o *.d *~ Makefile config.log config.status fixed_volume.h
	rm -f phmc_tm
	rm -f config.h

.PHONY: all clean compile-clean distclean dep \
	flex_read_input ${PROGRAMS} all-recursive \
	all-debug-recursive all-profile-recursive \
	clean-recursive distclean-recursive \
	compile-clean-recursive
