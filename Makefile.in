CC = @CC@
CCDEP = @CCDEP@
CFLAGS = @CFLAGS@ @OPTARGS@
LDFLAGS = @LDFLAGS@ @OPTARGS@
DEPFLAGS = @DEPFLAGS@
CCLD = $(CC)
LEX = @LEX@ 
AUTOCONF = @AUTOCONF@
LIBS = @LIBS@ 
SHELL = @SHELL@
OPTARGS = @OPTARGS@

LINK = $(CCLD) -o $@ ${LDFLAGS}
COMPILE = ${CC} -o $@ ${CFLAGS} 

MODULES = read_input clover_eo linsolve xchange \
	expo hybrid_update observables start \
	geometry_eo linalg_eo ranlxd sw io Hopping_Matrix \
	boundary deriv_Sb tm_operators getopt sighandler \
	mpi_init update_tm

PROGRAMS = hmc_tm testtrace thermal_cycle_tm
ALLOBJ = ${MODULES} ${PROGRAMS}


.SUFFIXES:

all: Makefile dep hmc_tm

-include $(addsuffix .d,$(ALLOBJ))

Makefile: Makefile.in config.status
	CONFIG_FILES=$@ CONFIG_HEADERS= $(SHELL) ./config.status

flex_read_input: read_input.l
	${LEX} -i -t $< > read_input.c

${addsuffix .o, ${MODULES}}: %.o: %.c %.d Makefile
	${COMPILE} -c $< 

${addsuffix .o, ${PROGRAMS}}: %.o: %.c %.d Makefile
	${COMPILE} -c $<

${PROGRAMS}: %: %.o ${addsuffix .o, ${MODULES}} 
	 ${LINK} ${addsuffix .o, ${MODULES}} $@.o $(LIBS)

$(addsuffix .d,$(ALLOBJ)): %.d: %.c Makefile
	 @ $(CCDEP) ${DEPFLAGS} ${INCLUDES} $< > $@ 

dep: $(addsuffix .d,$(ALLOBJ))

clean:
	rm -f *.o hybrid

.PHONY: all clean compile-clean distclean dep \
	flex_read_input ${PROGRAMS}
